{"version":3,"file":"index.js","sources":["../src/core/resolutions/NumberResolution.ts","../src/core/resolutions/TypedArrayResolution.ts","../src/core/resolutions/calculate.ts","../src/core/resolutions/BooleanResolution.ts","../src/core/convertor/Convertor.ts","../src/core/resolutions/StringResolution.ts","../src/core/scripts/Script.ts"],"sourcesContent":["import { Expression, Formula } from \"./Formula\";\nimport { ValueOf } from \"../types/ValueOf\";\nimport { Context } from \"../context/Context\";\nimport { calculateEvaluator, getFormulaEvaluator } from \"./calculate\";\n\n\n\nexport type NumberResolution = number | Formula | Expression | undefined;\n\nexport function calculateNumber(value: NumberResolution, defaultValue = 0): ValueOf<number> {\n    if (typeof(value) === \"number\") {\n        return value;\n    }\n    if (value === undefined) {\n        return {\n            valueOf() {\n                return defaultValue;\n            }\n        };\n    }\n    const evaluator = getFormulaEvaluator(value);\n    return {\n        valueOf(context?: Context): number {\n            return calculateEvaluator<number>(evaluator, context, value, defaultValue);\n        }\n    };\n}\n","import { Context } from \"../context/Context\";\nimport { TypedArray } from \"../types/TypedArray\";\nimport { ValueOf } from \"../types/ValueOf\";\nimport { Expression, Formula } from \"./Formula\";\nimport { NumberResolution, calculateNumber } from \"./NumberResolution\";\nimport { calculateEvaluator, getFormulaEvaluator } from \"./calculate\";\n\nexport type TypedArrayResolution = TypedArray | NumberResolution[] | Formula | Expression;\n\ninterface TypedArrayConstructor {\n    new (size: number): TypedArray;\n    BYTES_PER_ELEMENT: number;\n}\n\nexport function calculateTypedArray(value: TypedArrayResolution, ArrayConstructor: TypedArrayConstructor = Float32Array, defaultNumberValue = 0): ValueOf<TypedArray> {\n    if (value instanceof Float32Array || value instanceof Int8Array || value instanceof Uint8Array\n        || value instanceof Int16Array || value instanceof Uint16Array\n        || value instanceof Int32Array || value instanceof Uint32Array) {\n        return value;\n    }\n    if (Array.isArray(value)) {\n        const array = new ArrayConstructor(value.length);\n        const compiledArray = value.map(value => calculateNumber(value, defaultNumberValue));\n        return {\n            valueOf(context?: Context): TypedArray {\n                for (let i = 0; i < compiledArray.length; i++) {\n                    array[i] = compiledArray[i].valueOf(context);\n                }\n                return array;\n            }\n        };    \n    }\n    const formula = value;\n    const evaluator = getFormulaEvaluator(formula);\n    let bufferArray: TypedArray;\n    return {\n        valueOf(context?: Context): TypedArray {\n            const value = calculateEvaluator<TypedArray | undefined>(evaluator, context, formula, undefined);\n            if (value instanceof Float32Array || value instanceof Int8Array || value instanceof Uint8Array\n                || value instanceof Int16Array || value instanceof Uint16Array\n                || value instanceof Int32Array || value instanceof Uint32Array) {\n                return value;\n            }\n            if (typeof(value) === \"number\") {\n                if (!bufferArray) {\n                    bufferArray = new ArrayConstructor(value / ArrayConstructor.BYTES_PER_ELEMENT);\n                }\n                return bufferArray;\n            }\n            throw new Error(`Formula ${formula} doesnt't evaluate to a TypedArray.`);\n        }\n    };\n}","import * as math from \"mathjs\";\nimport { Context } from \"../context/Context\";\nimport { TypedArray } from \"../types/TypedArray\";\nimport { ValueOf } from \"../types/ValueOf\";\nimport { Resolution } from \"./Resolution\";\nimport { calculateTypedArray } from \"./TypedArrayResolution\";\nimport { Expression, Formula } from \"./Formula\";\n\nexport function calculateResolution(value: Resolution): ValueOf<SupportedTypes | undefined> {\n    if (value === undefined) {\n        return {\n            valueOf() {\n                return undefined;\n            }\n        };\n    }\n    if (value instanceof Float32Array || value instanceof Int8Array || value instanceof Uint8Array\n        || value instanceof Int16Array || value instanceof Uint16Array\n        || value instanceof Int32Array || value instanceof Uint32Array) {\n        return value;\n    }\n    if (typeof(value) === \"number\") {\n        return value;\n    }\n    if (Array.isArray(value)) {\n        return calculateTypedArray(value);\n    }\n    if (typeof(value) === \"string\" && (value.charAt(0) !== \"{\" || value.charAt(value.length-1) !== \"}\")) {\n        return value;\n    }\n    const evaluator = getFormulaEvaluator(value);\n    return {\n        valueOf(context?: Context): string | number | undefined {\n            return calculateEvaluator<string | number | undefined>(evaluator, context, value, undefined);\n        }\n    };\n}\n\n\nexport type SupportedTypes = string | number | TypedArray;\n\nexport function calculateEvaluator<T>(evaluator: math.EvalFunction, context: Context | undefined, formula: Formula | Expression, defaultValue: T): T {\n    const scope = context?.parameters[context.parameters.length-1];\n    try {\n        return evaluator.evaluate(scope ?? {}) ?? defaultValue;\n    } catch (e) {\n        console.error(\"Error: \" + e + \" on formula: \" + formula + \", scope: \", scope);\n    }\n    return defaultValue;\n}\n\nexport function getFormulaEvaluator(value: Formula | Expression): math.EvalFunction {\n    const formula = typeof(value) === \"string\" ? value : value.formula;\n    if (formula.charAt(0) !== \"{\" || formula.charAt(formula.length-1) !== \"}\") {\n        throw new Error(`Formula: ${value} must start and end with brackets.`);\n    }\n    const mathEvaluator = math.parse(formula.substring(1, formula.length - 1)).compile();\n    return mathEvaluator;\n}\n\n","import { Expression, Formula } from \"./Formula\";\nimport { ValueOf } from \"../types/ValueOf\";\nimport { Context } from \"../context/Context\";\nimport { calculateEvaluator, getFormulaEvaluator } from \"./calculate\";\n\nexport type BooleanResolution = boolean | Formula | Expression | undefined;\n\nexport function calculateBoolean(value: BooleanResolution, defaultValue = false): ValueOf<boolean> {\n    if (typeof(value) === \"boolean\") {\n        return value;\n    }\n    if (value === undefined) {\n        return {\n            valueOf() {\n                return defaultValue;\n            }\n        };\n    }\n    const evaluator = getFormulaEvaluator(value);\n    return {\n        valueOf(context?: Context): boolean {\n            return calculateEvaluator<boolean>(evaluator, context, value, defaultValue);\n        }\n    };\n}\n","import { DokAction } from \"../actions/Action\";\nimport { ScriptAction } from \"../actions/ScriptAction\";\nimport { Context } from \"../context/Context\";\nimport { ExecutionStep } from \"../execution/ExecutionStep\";\nimport { calculateBoolean } from \"../resolutions/BooleanResolution\";\nimport { calculateNumber } from \"../resolutions/NumberResolution\";\nimport { Resolution } from \"../resolutions/Resolution\";\nimport { SupportedTypes, calculateResolution } from \"../resolutions/calculate\";\nimport { Script } from \"../scripts/Script\";\nimport { ValueOf } from \"../types/ValueOf\";\n\nexport type Convertor = (action: DokAction, getSteps: (name: string) => ExecutionStep[], external?: Record<string, any>) => ExecutionStep | undefined;\n\nexport const DEFAULT_EXTERNALS = {\n    log: console.log,\n};\n\nfunction convertScriptAction(action: ScriptAction, getSteps: (name: string) => ExecutionStep[]): ExecutionStep {\n    const steps = getSteps(action.script);\n    const elseSteps = action.else ? getSteps(action.else) : undefined;\n    const resolutions: Record<string, Resolution> = (action.parameters ?? {});\n    const entries: [string, ValueOf<SupportedTypes | undefined>][] = Object.entries(resolutions).map(([key, resolution]) => [key, calculateResolution(resolution)]);\n    const loopResolution = action.loop ? calculateNumber(action.loop) : 1;\n    const conditionResolution = action.condition ? calculateBoolean(action.condition) : true;\n    return (context, parameters) => {\n        const paramValues: Record<string, SupportedTypes | undefined> = context.objectPool?.pop() ?? {};\n        context.parameters.push(paramValues);\n        paramValues.time = context.time;\n        for (let k in parameters) {\n            paramValues[k] = parameters[k];\n        }\n        for (let entry of entries) {\n            const key: string = entry[0];\n            paramValues[key] = entry[1].valueOf(context);\n        }\n\n        const numLoops = loopResolution.valueOf(context);\n        for (let index = 0; index < numLoops; index++) {\n            paramValues.index = index;\n            if (conditionResolution.valueOf(context)) {\n                for (let step of steps) {\n                    step(context, paramValues);\n                }        \n            } else if (elseSteps) {\n                for (let step of elseSteps) {\n                    step(context, paramValues);\n                }\n            }\n        }\n        const obj = context.parameters.pop();\n        if (obj) {\n            for (let k in obj) {\n                delete obj[k];\n            }\n            context.objectPool?.push(obj);\n        }\n    };\n}\n\nexport const convertAction: Convertor = (\n        action,\n        getSteps,\n        external = DEFAULT_EXTERNALS) => {\n    if (typeof(action.action) === \"string\" || !action.action) {\n        switch(action.action) {\n            case \"log\":\n                {\n                    const messages: Resolution[] = action.messages;\n                    const resolutions = messages.map(m => calculateResolution(m));\n                    return (context) => {\n                        external.log.apply(null, resolutions.map(r => r.valueOf(context)));\n                    }    \n                }\n            case undefined:\n            case \"execute-script\":\n                {\n                    return convertScriptAction(action as ScriptAction, getSteps);\n                }\n        }    \n    } else {\n        const dokAction: DokAction = action.action;\n        const elseAction: DokAction = action.else;\n        const step = convertAction(dokAction, getSteps, external);\n        const elseStep = action.else ? convertAction(elseAction, getSteps, external) : undefined;\n        const loopResolution = action.loop ? calculateNumber(action.loop) : 1;\n        const conditionResolution = action.condition ? calculateBoolean(action.condition) : true;\n        return (context, parameters) => {\n            const numLoops = loopResolution.valueOf(context);\n            for (let i = 0; i < numLoops; i++) {\n                parameters.index = i;\n                if (conditionResolution.valueOf(context)) {\n                    step?.(context, parameters);\n                } else {\n                    elseStep?.(context, parameters);\n                }\n            }\n        }\n    }\n    return;\n}\n\nexport const DEFAULT_CONVERTORS = {\n    \"log\": convertAction,\n    \"execute-script\": convertAction,\n    \"actionAction\": convertAction,\n};\n\nexport function convertScripts(\n    scripts: Script[],\n    convertors: Record<string, Convertor> = DEFAULT_CONVERTORS,\n    external: Record<string, any> = DEFAULT_EXTERNALS): Record<string, ExecutionStep[]> {\n    const scriptMap: Record<string, ExecutionStep[]> = {};\n    const getSteps = (name: string) => scriptMap[name];\n    scripts.forEach(script => {\n        if (!scriptMap[script.name]) {\n            scriptMap[script.name] = [];\n        }\n        const scriptSteps = scriptMap[script.name];\n        script.actions.forEach(action => {\n            const convertAction = typeof(action.action) === \"string\" ? convertors[action.action ?? \"execute-script\"] : convertors.actionAction;\n            const step = convertAction(action, getSteps, external);\n            if (step) {\n                scriptSteps.push(step);\n            }\n        });\n    });\n    return scriptMap;\n}\n\nexport function executeScript(\n        scriptName: string,\n        scripts: Script[],\n        context: Context,\n        convertors: Record<string, Convertor> = DEFAULT_CONVERTORS,\n        external: Record<string, any> = DEFAULT_EXTERNALS): void {\n    const scriptMap = convertScripts(scripts, convertors, external);\n    const scriptExecutionStep = convertScriptAction({\n        script: scriptName,\n    }, (name) => scriptMap[name]);\n    scriptExecutionStep(context, {});\n}\n","import { Context } from \"../context/Context\";\nimport { ValueOf } from \"../types/ValueOf\";\nimport { Expression, Formula } from \"./Formula\";\nimport { calculateEvaluator, getFormulaEvaluator } from \"./calculate\";\n\nexport type StringResolution = string | Formula | Expression | undefined;\n\nexport function calculateString(value: StringResolution, defaultValue = \"\"): ValueOf<string> {\n    if (typeof(value) === \"string\" && (value.charAt(0) !== \"{\" || value.charAt(value.length-1) !== \"}\")) {\n        return value;\n    }\n    if (value === undefined) {\n        return {\n            valueOf() {\n                return defaultValue;\n            }\n        };\n    }\n    const evaluator = getFormulaEvaluator(value);\n    return {\n        valueOf(context?: Context): string {\n            return calculateEvaluator<string>(evaluator, context, value, defaultValue);\n        }\n    };\n\n}\n","import { DokAction } from \"../actions/Action\";\nimport { Resolution } from \"../resolutions/Resolution\";\n\nexport type Tag = string|[string, string|number|boolean];\n\nexport interface Script {\n    name: string;\n    parameters?: (string|[string, Resolution])[];\n    actions: DokAction[];\n    tags?: Tag[];\n}\n\nexport function getByTags(scripts: Script[], tags: Tag[]): Script[] {\n    return scripts.filter(script => {\n        return tags.every(tag => {\n            if (typeof(tag) === \"string\") {\n                return script.tags?.some((t) => t === tag || (Array.isArray(t) && t[0] === tag))\n            } else {\n                return script.tags?.some((t) => \n                    Array.isArray(t) && t[0] === tag[0] && t[1] === tag[1]\n                );\n            }\n        });\n    });\n}\n\nexport function getByName(scripts: Script[], name: string | string[]): Script[] {\n    return scripts.filter(script => {\n        return name.includes(script.name);\n    });\n}"],"names":["calculateNumber","value","defaultValue","undefined","valueOf","evaluator","getFormulaEvaluator","context","calculateEvaluator","calculateTypedArray","ArrayConstructor","defaultNumberValue","Float32Array","Int8Array","Uint8Array","Int16Array","Uint16Array","Int32Array","Uint32Array","Array","isArray","array","length","compiledArray","map","i","formula","bufferArray","BYTES_PER_ELEMENT","Error","calculateResolution","charAt","scope","parameters","_evaluator$evaluate","evaluate","e","console","error","mathEvaluator","math","substring","compile","calculateBoolean","DEFAULT_EXTERNALS","log","convertScriptAction","action","getSteps","steps","script","elseSteps","resolutions","_action$parameters","entries","Object","_ref","key","resolution","loopResolution","loop","conditionResolution","condition","paramValues","_context$objectPool$p","_context$objectPool","objectPool","pop","push","time","k","_iterator","_createForOfIteratorHelperLoose","_step","done","entry","numLoops","index","_iterator2","_step2","step","_iterator3","_step3","obj","_context$objectPool2","convertAction","external","messages","m","apply","r","dokAction","elseAction","elseStep","DEFAULT_CONVERTORS","convertScripts","scripts","convertors","scriptMap","name","forEach","scriptSteps","actions","_action$action","actionAction","executeScript","scriptName","scriptExecutionStep","calculateString","getByTags","tags","filter","every","tag","_script$tags","some","t","_script$tags2","getByName","includes"],"mappings":"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"}